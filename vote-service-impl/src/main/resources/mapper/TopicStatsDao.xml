<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.duan.vote.dao.TopicStatsDao">

    <select id="findTopicStatsByIds" resultType="com.duan.vote.entity.TopicStats">
        SELECT vc.topic_id, dvc.disagree, avc.agree, it.interestUserCount
        FROM (
        (SELECT uvc.topic_id AS topic_id FROM user_vote_comment uvc WHERE uvc.topic_id IN
        <foreach collection="ids"
                 item="id"
                 open="("
                 separator=","
                 close=")">
            #{id}
        </foreach>
        GROUP BY uvc.topic_id) vc
        LEFT JOIN
        (SELECT duvc.topic_id AS topic_id, SUM(duvc.vote) AS disagree FROM user_vote_comment duvc WHERE duvc.vote &lt; 0
        GROUP BY duvc.topic_id) dvc ON vc.topic_id = dvc.topic_id
        LEFT JOIN
        (SELECT auvc.topic_id AS topic_id, SUM(auvc.vote) AS agree FROM user_vote_comment auvc WHERE auvc.vote &gt; 0
        GROUP BY auvc.topic_id) avc ON vc.topic_id = avc.topic_id
        LEFT JOIN
        (SELECT uit.topic_id AS topic_id, COUNT(uit.user_id) AS interestUserCount FROM user_interest_topic uit GROUP BY
        uit.topic_id) it ON vc.topic_id = it.topic_id)
    </select>
</mapper>