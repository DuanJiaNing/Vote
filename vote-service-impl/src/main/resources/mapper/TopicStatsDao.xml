<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.duan.vote.dao.TopicStatsDao">

    <select id="simpleStats" resultType="com.duan.vote.dto.TopicSummaryDTO">
        SELECT t.id AS topic_id, t.title, t.notes, t.insert_time, iuc.interest_user_count, cvc.vote_count
        FROM (
        SELECT id, title, notes, insert_time
        FROM topic
        <where>
            <if test="title != null and title.length() > 0">
                AND title LIKE '%${title}%'
            </if>
            <if test="userId != null">
                AND user_id = #{userId}
            </if>
        </where>
        ) t
        LEFT JOIN (
        SELECT topic_id, COUNT(user_id) AS interest_user_count
        FROM user_interest_topic
        GROUP BY topic_id) iuc
        ON iuc.topic_id = t.id
        LEFT JOIN (
        SELECT c.topic_id, SUM(cv.vote_count) AS vote_count
        FROM (
        SELECT id, topic_id
        FROM comment) c
        LEFT JOIN(
        SELECT COUNT(vote) vote_count, comment_id
        FROM comment_vote
        GROUP BY comment_id) cv
        ON c.id = cv.comment_id
        GROUP BY topic_id) cvc
        ON cvc.topic_id = t.id
    </select>

    <select id="listInterestStats" resultType="com.duan.vote.dto.TopicSummaryDTO">
# TODO
    </select>

    <select id="getStats" resultType="com.duan.vote.dto.TopicSummaryDTO">
        SELECT t.id AS topic_id, t.title, t.notes, t.insert_time, iuc.interest_user_count, cvc.vote_count
        FROM (
                 SELECT id, title, notes, insert_time
                 FROM topic
                 WHERE id = #{topicId}) t
                 LEFT JOIN (
            SELECT topic_id, COUNT(user_id) AS interest_user_count
            FROM user_interest_topic
            GROUP BY topic_id) iuc
                           ON iuc.topic_id = t.id
                 LEFT JOIN (
            SELECT c.topic_id, SUM(cv.vote_count) AS vote_count
            FROM (
                     SELECT id, topic_id
                     FROM comment) c
                     LEFT JOIN(
                SELECT COUNT(vote) vote_count, comment_id
                FROM comment_vote
                GROUP BY comment_id) cv
                              ON c.id = cv.comment_id
            GROUP BY topic_id) cvc
                           ON cvc.topic_id = t.id
    </select>
</mapper>